<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>中文学习互动教室 - Lớp học tiếng Trung tương tác</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        /* 全局样式 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', 'Noto Sans SC', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            border: 3px solid #d32f2f; /* 中国红边框 */
        }

        /* 头部样式 */
        header {
            background: linear-gradient(to right, #d32f2f, #f44336); /* 中国红渐变 */
            color: white;
            padding: 25px 30px;
            text-align: center;
            position: relative;
        }

        .header-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .language-subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-bottom: 15px;
        }

        .chinese-title {
            font-weight: bold;
        }

        .vietnamese-title {
            font-weight: normal;
        }

        .firebase-status {
            background-color: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            margin-top: 10px;
            display: inline-block;
        }

        /* 主体内容 */
        .main-content {
            display: flex;
            min-height: 700px;
        }

        .left-panel {
            flex: 1;
            background-color: #f9f9f9;
            padding: 30px;
            border-right: 2px dashed #e0e0e0;
        }

        .right-panel {
            flex: 2;
            padding: 30px;
            background-color: #fffef7; /* 浅黄色背景 */
            display: flex;
            flex-direction: column;
        }

        /* 面板通用样式 */
        .panel {
            margin-bottom: 30px;
        }

        .panel-title {
            font-size: 1.8rem;
            color: #d32f2f; /* 中国红 */
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ffd54f; /* 黄色 */
            display: flex;
            align-items: center;
        }

        .panel-title i {
            margin-right: 10px;
        }

        .panel-subtitle {
            font-size: 1rem;
            color: #666;
            margin-bottom: 15px;
        }

        /* 房间输入部分 */
        .room-input-section {
            background-color: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border: 2px solid #ffd54f; /* 黄色边框 */
        }

        .input-group {
            display: flex;
            margin-bottom: 15px;
        }

        .input-label {
            flex: 1;
            font-weight: bold;
            color: #d32f2f;
            display: flex;
            align-items: center;
        }

        .input-field {
            flex: 2;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .input-field:focus {
            border-color: #d32f2f;
            outline: none;
            box-shadow: 0 0 0 3px rgba(211, 47, 47, 0.2);
        }

        .btn {
            padding: 12px 25px;
            background-color: #d32f2f;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .btn:hover {
            background-color: #b71c1c;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(211, 47, 47, 0.3);
        }

        .btn i {
            margin-right: 8px;
        }

        .btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background-color: #ffd54f;
            color: #333;
        }

        .btn-secondary:hover {
            background-color: #ffc107;
        }

        /* 角色选择部分 */
        .role-selection {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .role-card {
            background-color: white;
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid transparent;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .role-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .role-card.selected {
            border-color: #4caf50;
            background-color: #e8f5e9;
        }

        .role-card.disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background-color: #f5f5f5;
        }

        .role-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #d32f2f;
        }

        .role-card.disabled .role-icon {
            color: #999;
        }

        .role-name {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: #d32f2f;
        }

        .role-card.disabled .role-name {
            color: #666;
        }

        .role-description {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 15px;
        }

        .role-status {
            font-size: 0.9rem;
            padding: 5px 10px;
            border-radius: 15px;
            display: inline-block;
            margin-top: 10px;
        }

        .status-available {
            background-color: #e8f5e9;
            color: #2e7d32;
        }

        .status-taken {
            background-color: #ffebee;
            color: #d32f2f;
        }

        /* 情景选择部分 */
        .scenario-selection {
            margin-top: 20px;
        }

        .scenario-list {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .scenario-card {
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        }

        .scenario-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-color: #ffd54f;
        }

        .scenario-card.selected {
            background-color: #e3f2fd;
            border-color: #1976d2;
        }

        .scenario-title {
            font-weight: bold;
            color: #d32f2f;
            margin-bottom: 5px;
            font-size: 1.1rem;
        }

        .scenario-fruits {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 5px;
        }

        .scenario-tasks {
            font-size: 0.85rem;
            color: #888;
            font-style: italic;
        }

        /* 聊天部分 */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 400px;
            border: 2px solid #ffd54f;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .chat-header {
            background-color: #d32f2f;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-info {
            display: flex;
            align-items: center;
        }

        .chat-info i {
            margin-right: 10px;
        }

        .room-code-display {
            background-color: rgba(255, 255, 255, 0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: #fffef7;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 80%;
            padding: 15px;
            border-radius: 15px;
            position: relative;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-buyer {
            align-self: flex-start;
            background-color: #e3f2fd;
            border-bottom-left-radius: 5px;
            border-left: 4px solid #1976d2;
        }

        .message-seller {
            align-self: flex-end;
            background-color: #f3e5f5;
            border-bottom-right-radius: 5px;
            border-right: 4px solid #7b1fa2;
        }

        .message-system {
            align-self: center;
            background-color: #fff3e0;
            color: #e65100;
            font-style: italic;
            text-align: center;
            max-width: 90%;
            font-size: 0.9rem;
        }

        .message-sender {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .message-sender.buyer {
            color: #1976d2;
        }

        .message-sender.seller {
            color: #7b1fa2;
        }

        .message-content {
            margin-bottom: 5px;
        }

        .message-translation {
            font-size: 0.85rem;
            color: #666;
            border-top: 1px dashed rgba(0, 0, 0, 0.1);
            padding-top: 8px;
            margin-top: 8px;
        }

        .message-time {
            font-size: 0.75rem;
            color: #999;
            text-align: right;
            margin-top: 5px;
        }

        /* 对话选项部分 */
        .dialogue-options {
            background-color: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border: 2px solid #ffd54f;
            margin-top: 20px;
        }

        .dialogue-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            color: #d32f2f;
        }

        .dialogue-header i {
            margin-right: 10px;
            font-size: 1.2rem;
        }

        .dialogue-category {
            font-size: 1rem;
            color: #666;
            margin-bottom: 10px;
            padding-left: 30px;
        }

        .options-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        @media (max-width: 1200px) {
            .options-container {
                grid-template-columns: 1fr;
            }
        }

        .option-btn {
            padding: 12px 15px;
            background-color: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            text-align: left;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.95rem;
            color: #333;
        }

        .option-btn:hover {
            background-color: #f5f5f5;
            border-color: #d32f2f;
        }

        .option-btn.selected {
            background-color: #e3f2fd;
            border-color: #1976d2;
            color: #1976d2;
        }

        .option-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .option-text {
            font-weight: 500;
        }

        .option-translation {
            font-size: 0.85rem;
            color: #666;
            margin-top: 3px;
        }

        /* 用户列表 */
        .user-list {
            background-color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-top: 20px;
        }

        .user-list-title {
            font-size: 1.3rem;
            color: #d32f2f;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .user-list-title i {
            margin-right: 10px;
        }

        .user-item {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .user-item:last-child {
            border-bottom: none;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #d32f2f;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-weight: bold;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-weight: bold;
            color: #333;
        }

        .user-role {
            font-size: 0.9rem;
            color: #666;
        }

        /* 响应式设计 */
        @media (max-width: 992px) {
            .main-content {
                flex-direction: column;
            }
            
            .left-panel {
                border-right: none;
                border-bottom: 2px dashed #e0e0e0;
            }
        }

        @media (max-width: 768px) {
            .role-selection {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .chat-container {
                height: 350px;
            }
            
            .message {
                max-width: 90%;
            }
        }

        /* 隐藏部分 */
        .hidden {
            display: none !important;
        }

        /* 工具类 */
        .flex-center {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mt-20 {
            margin-top: 20px;
        }

        .mb-20 {
            margin-bottom: 20px;
        }

        .text-center {
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 头部 -->
        <header>
            <div class="header-content">
                <h1>
                    <span class="chinese-title">中文学习互动教室</span>
                    <br>
                    <span class="vietnamese-title">Lớp học tiếng Trung tương tác</span>
                </h1>
                <div class="language-subtitle">买卖水果角色扮演 / Diễn vai mua bán trái cây</div>
                <div class="firebase-status" id="firebaseStatus">
                    <i class="fas fa-circle" style="color: #ccc; margin-right: 5px;"></i>
                    <span>连接状态: 正在连接... / Trạng thái: Đang kết nối...</span>
                </div>
            </div>
        </header>

        <div class="main-content">
            <!-- 左侧面板 -->
            <div class="left-panel">
                <!-- 房间输入部分 -->
                <div class="panel" id="roomInputPanel">
                    <div class="panel-title">
                        <i class="fas fa-door-open"></i>
                        <span>进入教室 / Vào lớp học</span>
                    </div>
                    <div class="panel-subtitle">
                        请输入房间号加入教室 / Vui lòng nhập mã phòng để tham gia lớp học
                    </div>
                    <div class="room-input-section">
                        <div class="input-group">
                            <div class="input-label">房间号 / Mã phòng:</div>
                            <input type="text" class="input-field" id="roomCodeInput" placeholder="例如: CN01 / Ví dụ: CN01" maxlength="10">
                        </div>
                        <div class="input-group">
                            <div class="input-label">用户名 / Tên người dùng:</div>
                            <input type="text" class="input-field" id="userNameInput" placeholder="请输入用户名 / Vui lòng nhập tên" maxlength="20">
                        </div>
                        <div class="text-center mt-20">
                            <button class="btn" id="joinRoomBtn">
                                <i class="fas fa-sign-in-alt"></i>
                                <span>进入教室 / Vào lớp học</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 角色选择部分 -->
                <div class="panel hidden" id="roleSelectionPanel">
                    <div class="panel-title">
                        <i class="fas fa-user-friends"></i>
                        <span>选择角色 / Chọn vai trò</span>
                    </div>
                    <div class="panel-subtitle">
                        请选择一个角色开始对话 / Vui lòng chọn một vai trò để bắt đầu hội thoại
                    </div>
                    <div class="role-selection">
                        <div class="role-card" id="buyerRoleCard" data-role="buyer">
                            <div class="role-icon">
                                <i class="fas fa-shopping-basket"></i>
                            </div>
                            <div class="role-name">买家 / Người mua</div>
                            <div class="role-description">
                                必须买至少3种水果；必须讲价；付款时给大面额钞票<br>
                                Mua ít nhất 3 loại; phải trả giá; đưa tiền mệnh giá lớn
                            </div>
                            <div class="role-status status-available" id="buyerStatus">
                                可选 / Có thể chọn
                            </div>
                        </div>
                        <div class="role-card" id="sellerRoleCard" data-role="seller">
                            <div class="role-icon">
                                <i class="fas fa-store"></i>
                            </div>
                            <div class="role-name">卖家 / Người bán</div>
                            <div class="role-description">
                                必须推荐其他水果；态度热情；感谢顾客<br>
                                Gợi ý thêm; nhiệt tình; cảm ơn khách hàng
                            </div>
                            <div class="role-status status-available" id="sellerStatus">
                                可选 / Có thể chọn
                            </div>
                        </div>
                    </div>
                    
                    <!-- 情景选择部分 -->
                    <div class="scenario-selection hidden" id="scenarioSelection">
                        <div class="panel-title">
                            <i class="fas fa-scroll"></i>
                            <span>选择情景 / Chọn tình huống</span>
                        </div>
                        <div class="panel-subtitle">
                            选择一个情景开始练习 / Chọn một tình huống để bắt đầu luyện tập
                        </div>
                        <div class="scenario-list" id="scenarioList">
                            <!-- 情景列表将动态生成 -->
                        </div>
                    </div>
                    
                    <div class="text-center mt-20">
                        <button class="btn btn-secondary" id="leaveRoomBtn">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>离开房间 / Rời phòng</span>
                        </button>
                    </div>
                </div>

                <!-- 用户列表 -->
                <div class="user-list hidden" id="userListPanel">
                    <div class="user-list-title">
                        <i class="fas fa-users"></i>
                        <span>在线用户 / Người dùng trực tuyến</span>
                    </div>
                    <div id="userList">
                        <!-- 用户列表将动态生成 -->
                    </div>
                </div>
            </div>

            <!-- 右侧面板 -->
            <div class="right-panel">
                <!-- 聊天部分 -->
                <div class="panel hidden" id="chatPanel">
                    <div class="panel-title">
                        <i class="fas fa-comments"></i>
                        <span>对话练习 / Luyện tập hội thoại</span>
                    </div>
                    <div class="panel-subtitle" id="chatSubtitle">
                        请选择一个角色开始对话 / Vui lòng chọn một vai trò để bắt đầu hội thoại
                    </div>
                    <div class="chat-container">
                        <div class="chat-header">
                            <div class="chat-info">
                                <i class="fas fa-comment-dots"></i>
                                <span>实时对话 / Hội thoại thời gian thực</span>
                            </div>
                            <div class="chat-info">
                                <span>房间 / Phòng:</span>
                                <div class="room-code-display" id="currentRoomCode">---</div>
                            </div>
                        </div>
                        <div class="chat-messages" id="chatMessages">
                            <div class="message message-system">
                                <div class="message-content">欢迎来到中文学习互动教室！请先加入房间并选择角色和情景。</div>
                                <div class="message-translation">Chào mừng đến với lớp học tiếng Trung tương tác! Hãy tham gia phòng và chọn vai trò, tình huống trước.</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 对话选项部分 -->
                    <div class="dialogue-options hidden" id="dialogueOptions">
                        <div class="dialogue-header">
                            <i class="fas fa-keyboard"></i>
                            <span>请选择对话选项 / Vui lòng chọn tùy chọn hội thoại</span>
                        </div>
                        <div id="optionsContainer">
                            <!-- 选项将动态生成 -->
                        </div>
                    </div>
                </div>

                <!-- 等待加入部分 -->
                <div class="panel" id="waitingPanel">
                    <div class="panel-title">
                        <i class="fas fa-hourglass-half"></i>
                        <span>等待加入 / Đang chờ tham gia</span>
                    </div>
                    <div class="panel-subtitle">
                        请先加入房间开始学习 / Vui lòng tham gia phòng để bắt đầu học
                    </div>
                    <div class="flex-center" style="height: 400px;">
                        <div class="text-center">
                            <div class="role-icon" style="font-size: 5rem; margin-bottom: 30px;">
                                <i class="fas fa-shopping-basket"></i>
                            </div>
                            <h2 style="color: #d32f2f; margin-bottom: 20px;">买卖水果角色扮演</h2>
                            <p style="color: #666; margin-bottom: 30px; max-width: 500px;">
                                这是一个供两名学生使用的角色扮演模拟环境，通过选择句子完成对话练习。
                                <br>
                                Đây là môi trường mô phỏng đóng vai cho hai học sinh, hoàn thành bài tập hội thoại bằng cách chọn câu.
                            </p>
                            <p style="color: #d32f2f; font-weight: bold;">
                                使用说明 / Hướng dẫn sử dụng:
                            </p>
                            <ol style="text-align: left; display: inline-block; margin-top: 15px; color: #666;">
                                <li>输入房间号和用户名 / Nhập mã phòng và tên người dùng</li>
                                <li>选择买家或卖家角色 / Chọn vai trò người mua hoặc người bán</li>
                                <li>选择一个情景练习 / Chọn một tình huống để luyện tập</li>
                                <li>通过选择选项完成对话 / Hoàn thành hội thoại bằng cách chọn tùy chọn</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 页脚 -->
        <footer style="padding: 20px; text-align: center; color: #666; border-top: 2px solid #f0f0f0;">
            <p>实时互动中文学习Web应用 / Ứng dụng Web học tiếng Trung tương tác thời gian thực</p>
            <p>使用 Firebase 实时数据库 / Sử dụng Firebase Realtime Database</p>
            <p>© 2023 中文学习互动教室 - Lớp học tiếng Trung tương tác</p>
        </footer>
    </div>

    <script>
        // Firebase 配置
        const firebaseConfig = {
            apiKey: "AIzaSyDcsk8X1rFd1qMd1W9510-ZKFlSfZUUKV8",
            authDomain: "lop-hoc-tuong-tac-26351.firebaseapp.com",
            databaseURL: "https://lop-hoc-tuong-tac-26351-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "lop-hoc-tuong-tac-26351",
            storageBucket: "lop-hoc-tuong-tac-26351.firebasestorage.app",
            messagingSenderId: "854589974779",
            appId: "1:854589974779:web:038a2f3d54cb443a6f685e"
        };

        // 初始化 Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // DOM 元素
        const roomCodeInput = document.getElementById('roomCodeInput');
        const userNameInput = document.getElementById('userNameInput');
        const joinRoomBtn = document.getElementById('joinRoomBtn');
        const leaveRoomBtn = document.getElementById('leaveRoomBtn');
        const buyerRoleCard = document.getElementById('buyerRoleCard');
        const sellerRoleCard = document.getElementById('sellerRoleCard');
        const buyerStatus = document.getElementById('buyerStatus');
        const sellerStatus = document.getElementById('sellerStatus');
        const chatMessages = document.getElementById('chatMessages');
        const userList = document.getElementById('userList');
        const currentRoomCode = document.getElementById('currentRoomCode');
        const firebaseStatus = document.getElementById('firebaseStatus');
        const chatSubtitle = document.getElementById('chatSubtitle');
        const optionsContainer = document.getElementById('optionsContainer');
        const scenarioList = document.getElementById('scenarioList');
        const scenarioSelection = document.getElementById('scenarioSelection');

        // 面板
        const roomInputPanel = document.getElementById('roomInputPanel');
        const roleSelectionPanel = document.getElementById('roleSelectionPanel');
        const userListPanel = document.getElementById('userListPanel');
        const chatPanel = document.getElementById('chatPanel');
        const waitingPanel = document.getElementById('waitingPanel');
        const dialogueOptions = document.getElementById('dialogueOptions');

        // 应用状态
        let currentUser = {
            id: null,
            name: null,
            role: null,
            roomCode: null
        };

        let currentRoom = {
            code: null,
            users: {},
            roles: {
                buyer: null,
                seller: null
            },
            messages: [],
            currentScenario: null,
            currentStep: 0
        };

        // 情景数据
        const scenarios = {
            1: {
                id: 1,
                title: "豪华派对 / Tiệc sang trọng",
                fruits: "榴莲, 山竹, 樱桃 / Sầu riêng, Măng cụt, Anh đào",
                description: "为豪华派对准备水果 / Chuẩn bị trái cây cho bữa tiệc sang trọng",
                buyerTasks: ["买榴莲、山竹和樱桃 / Mua sầu riêng, măng cụt và anh đào"],
                sellerTasks: ["推荐苹果 / Gợi ý táo"],
                dialogueFlow: [
                    {
                        speaker: "seller",
                        category: "问候与需求 / Chào hỏi & Nhu cầu",
                        options: [
                            { 
                                chinese: "您好，欢迎光临！您买什么？", 
                                vietnamese: "Xin chào, chào mừng quý khách! Quý khách mua gì?" 
                            }
                        ]
                    },
                    {
                        speaker: "buyer",
                        category: "问候与需求 / Chào hỏi & Nhu cầu",
                        options: [
                            { 
                                chinese: "你好。我想买水果。今天的榴莲怎么样？", 
                                vietnamese: "Xin chào. Tôi muốn mua trái cây. Sầu riêng hôm nay thế nào?" 
                            },
                            { 
                                chinese: "你好，我想看看水果。榴莲新鲜吗？", 
                                vietnamese: "Xin chào, tôi muốn xem trái cây. Sầu riêng có tươi không?" 
                            }
                        ]
                    },
                    {
                        speaker: "seller",
                        category: "选购 / Chọn mua",
                        options: [
                            { 
                                chinese: "今天的榴莲很新鲜，也好吃。您要一个吧？", 
                                vietnamese: "Sầu riêng hôm nay rất tươi, cũng rất ngon. Quý khách lấy một quả nhé?" 
                            },
                            { 
                                chinese: "榴莲今天刚到，非常新鲜，来一个吧？", 
                                vietnamese: "Sầu riêng mới đến hôm nay, rất tươi, lấy một quả nhé?" 
                            }
                        ]
                    },
                    {
                        speaker: "buyer",
                        category: "选购 / Chọn mua",
                        options: [
                            { 
                                chinese: "榴莲怎么卖？", 
                                vietnamese: "Sầu riêng bán thế nào?" 
                            },
                            { 
                                chinese: "榴莲多少钱一斤？", 
                                vietnamese: "Sầu riêng bao nhiêu tiền một cân?" 
                            }
                        ]
                    },
                    {
                        speaker: "seller",
                        category: "选购 / Chọn mua",
                        options: [
                            { 
                                chinese: "二十五块一斤。", 
                                vietnamese: "25 đồng một cân." 
                            },
                            { 
                                chinese: "今天特价，二十五块一斤。", 
                                vietnamese: "Hôm nay giảm giá, 25 đồng một cân." 
                            }
                        ]
                    },
                    {
                        speaker: "buyer",
                        category: "讲价 / Trả giá",
                        options: [
                            { 
                                chinese: "二十五块？太贵了！便宜点儿吧。", 
                                vietnamese: "25 đồng? Đắt quá! Rẻ chút đi." 
                            },
                            { 
                                chinese: "这么贵啊？能不能便宜点？", 
                                vietnamese: "Đắt thế ư? Có thể rẻ một chút không?" 
                            }
                        ]
                    },
                    {
                        speaker: "seller",
                        category: "讲价 / Trả giá",
                        options: [
                            { 
                                chinese: "那二十三块吧，这是最好的榴莲。", 
                                vietnamese: "Vậy 23 đồng nhé, đây là sầu riêng ngon nhất." 
                            },
                            { 
                                chinese: "好吧，二十三块，不能再便宜了。", 
                                vietnamese: "Được thôi, 23 đồng, không thể rẻ hơn được." 
                            }
                        ]
                    },
                    {
                        speaker: "buyer",
                        category: "选购 / Chọn mua",
                        options: [
                            { 
                                chinese: "好吧，来一个。还要两斤山竹和一斤樱桃。一共多少钱？", 
                                vietnamese: "Được thôi, lấy một quả. Còn muốn 2 cân măng cụt và 1 cân anh đào. Tổng cộng bao nhiêu tiền?" 
                            },
                            { 
                                chinese: "行，要一个榴莲，再加两斤山竹和一斤樱桃。总共多少钱？", 
                                vietnamese: "Được, lấy một quả sầu riêng, thêm 2 cân măng cụt và 1 cân anh đào. Tổng cộng bao nhiêu tiền?" 
                            }
                        ]
                    },
                    {
                        speaker: "seller",
                        category: "促销 / Gợi ý thêm",
                        options: [
                            { 
                                chinese: "您还要别的吗？我们还有很好的苹果。", 
                                vietnamese: "Quý khách còn muốn gì nữa không? Chúng tôi còn có táo rất ngon." 
                            },
                            { 
                                chinese: "还要别的吗？今天的苹果特别甜。", 
                                vietnamese: "Còn muốn gì nữa không? Táo hôm nay đặc biệt ngọt." 
                            }
                        ]
                    },
                    {
                        speaker: "buyer",
                        category: "促销 / Gợi ý thêm",
                        options: [
                            { 
                                chinese: "不用了，谢谢。", 
                                vietnamese: "Không cần nữa, cảm ơn." 
                            },
                            { 
                                chinese: "不用了，这些就够了。", 
                                vietnamese: "Không cần nữa, những thứ này là đủ rồi." 
                            }
                        ]
                    },
                    {
                        speaker: "seller",
                        category: "结账 / Thanh toán",
                        options: [
                            { 
                                chinese: "一共八十八块。", 
                                vietnamese: "Tổng cộng 88 đồng." 
                            },
                            { 
                                chinese: "总共八十八块钱。", 
                                vietnamese: "Tổng cộng 88 đồng." 
                            }
                        ]
                    },
                    {
                        speaker: "buyer",
                        category: "结账 / Thanh toán",
                        options: [
                            { 
                                chinese: "给你一百块。", 
                                vietnamese: "Đưa bạn 100 đồng." 
                            },
                            { 
                                chinese: "这是一百块。", 
                                vietnamese: "Đây là 100 đồng." 
                            }
                        ]
                    },
                    {
                        speaker: "seller",
                        category: "结账 / Thanh toán",
                        options: [
                            { 
                                chinese: "谢谢。这是您的水果，找您十二块。慢走！", 
                                vietnamese: "Cảm ơn. Đây là trái cây của quý khách, trả lại 12 đồng. Đi từ từ!" 
                            },
                            { 
                                chinese: "谢谢。找您十二块。欢迎下次光临！", 
                                vietnamese: "Cảm ơn. Trả lại 12 đồng. Chào mừng lần sau lại đến!" 
                            }
                        ]
                    }
                ]
            },
            2: {
                id: 2,
                title: "夏日生日派对 / Tiệc sinh nhật mùa hè",
                fruits: "西瓜, 菠萝, 芒果 / Dưa hấu, Dứa, Xoài",
                description: "为夏日生日派对准备水果 / Chuẩn bị trái cây cho tiệc sinh nhật mùa hè",
                buyerTasks: ["讲价: 这里的西瓜比隔壁贵 / Trả giá: Dưa hấu ở đây đắt hơn bên cạnh"],
                sellerTasks: [],
                dialogueFlow: [
                    {
                        speaker: "seller",
                        category: "问候与需求 / Chào hỏi & Nhu cầu",
                        options: [
                            { 
                                chinese: "您好，欢迎光临！您买什么？", 
                                vietnamese: "Xin chào, chào mừng quý khách! Quý khách mua gì?" 
                            }
                        ]
                    },
                    {
                        speaker: "buyer",
                        category: "问候与需求 / Chào hỏi & Nhu cầu",
                        options: [
                            { 
                                chinese: "你好。我想买西瓜。", 
                                vietnamese: "Xin chào. Tôi muốn mua dưa hấu." 
                            },
                            { 
                                chinese: "你好，今天的西瓜怎么样？", 
                                vietnamese: "Xin chào, dưa hấu hôm nay thế nào?" 
                            }
                        ]
                    },
                    {
                        speaker: "seller",
                        category: "选购 / Chọn mua",
                        options: [
                            { 
                                chinese: "今天的西瓜很甜，也很新鲜。", 
                                vietnamese: "Dưa hấu hôm nay rất ngọt, cũng rất tươi." 
                            },
                            { 
                                chinese: "西瓜今天特价，很划算。", 
                                vietnamese: "Dưa hấu hôm nay giảm giá, rất hợp lý." 
                            }
                        ]
                    },
                    {
                        speaker: "buyer",
                        category: "选购 / Chọn mua",
                        options: [
                            { 
                                chinese: "西瓜怎么卖？", 
                                vietnamese: "Dưa hấu bán thế nào?" 
                            },
                            { 
                                chinese: "西瓜多少钱一斤？", 
                                vietnamese: "Dưa hấu bao nhiêu tiền một cân?" 
                            }
                        ]
                    },
                    {
                        speaker: "seller",
                        category: "选购 / Chọn mua",
                        options: [
                            { 
                                chinese: "十块一斤。", 
                                vietnamese: "10 đồng một cân." 
                            },
                            { 
                                chinese: "今天特价，八块一斤。", 
                                vietnamese: "Hôm nay giảm giá, 8 đồng một cân." 
                            }
                        ]
                    },
                    {
                        speaker: "buyer",
                        category: "讲价 / Trả giá",
                        options: [
                            { 
                                chinese: "十块？太贵了！这里的西瓜比隔壁贵。便宜点儿吧。", 
                                vietnamese: "10 đồng? Đắt quá! Dưa hấu ở đây đắt hơn bên cạnh. Rẻ chút đi." 
                            },
                            { 
                                chinese: "八块？还是有点贵，再便宜点吧。", 
                                vietnamese: "8 đồng? Vẫn hơi đắt, rẻ thêm chút nữa đi." 
                            }
                        ]
                    },
                    {
                        speaker: "seller",
                        category: "讲价 / Trả giá",
                        options: [
                            { 
                                chinese: "那八块吧，不能再便宜了。", 
                                vietnamese: "Vậy 8 đồng nhé, không thể rẻ hơn được." 
                            },
                            { 
                                chinese: "最低七块，不能再低了。", 
                                vietnamese: "Thấp nhất 7 đồng, không thể thấp hơn được." 
                            }
                        ]
                    },
                    {
                        speaker: "buyer",
                        category: "选购 / Chọn mua",
                        options: [
                            { 
                                chinese: "好吧。我还要菠萝和芒果。一共多少钱？", 
                                vietnamese: "Được thôi. Tôi còn muốn dứa và xoài. Tổng cộng bao nhiêu tiền?" 
                            },
                            { 
                                chinese: "行，那我再要两斤菠萝和一斤芒果。总共多少钱？", 
                                vietnamese: "Được, vậy tôi muốn thêm 2 cân dứa và 1 cân xoài. Tổng cộng bao nhiêu tiền?" 
                            }
                        ]
                    },
                    {
                        speaker: "seller",
                        category: "结账 / Thanh toán",
                        options: [
                            { 
                                chinese: "一共四十五块。", 
                                vietnamese: "Tổng cộng 45 đồng." 
                            },
                            { 
                                chinese: "总共四十五块。", 
                                vietnamese: "Tổng cộng 45 đồng." 
                            }
                        ]
                    },
                    {
                        speaker: "buyer",
                        category: "结账 / Thanh toán",
                        options: [
                            { 
                                chinese: "给你五十块。", 
                                vietnamese: "Đưa bạn 50 đồng." 
                            },
                            { 
                                chinese: "这是五十块。", 
                                vietnamese: "Đây là 50 đồng." 
                            }
                        ]
                    },
                    {
                        speaker: "seller",
                        category: "结账 / Thanh toán",
                        options: [
                            { 
                                chinese: "谢谢。找您五块。欢迎下次光临！", 
                                vietnamese: "Cảm ơn. Trả lại 5 đồng. Chào mừng lần sau lại đến!" 
                            },
                            { 
                                chinese: "好的，找您五块。谢谢光临！", 
                                vietnamese: "Được, trả lại 5 đồng. Cảm ơn quý khách!" 
                            }
                        ]
                    }
                ]
            },
            3: {
                id: 3,
                title: "看望病人 / Thăm người ốm",
                fruits: "橙子, 苹果, 葡萄 / Cam, Táo, Nho",
                description: "买水果看望病人 / Mua trái cây thăm người ốm",
                buyerTasks: ["讲价: 我买很多，给我批发价吧 / Trả giá: Tôi mua nhiều, bán giá buôn đi"],
                sellerTasks: [],
                dialogueFlow: [] // 简化为与情景2类似结构
            },
            4: {
                id: 4,
                title: "下午茶 / Tiệc trà chiều",
                fruits: "草莓, 火龙果, 龙眼 / Dâu tây, Thanh long, Nhãn",
                description: "为下午茶准备水果 / Chuẩn bị trái cây cho tiệc trà chiều",
                buyerTasks: [],
                sellerTasks: ["夸草莓非常甜 / Khen dâu tây cực kỳ ngọt"],
                dialogueFlow: [] // 简化为与情景2类似结构
            },
            5: {
                id: 5,
                title: "儿童聚会 / Tiệc cho trẻ em",
                fruits: "香蕉, 橘子, 木瓜 / Chuối, Quýt, Đu đủ",
                description: "为儿童聚会准备水果 / Chuẩn bị trái cây cho tiệc trẻ em",
                buyerTasks: ["讲价: 把零头抹了吧 / Trả giá: Bớt số lẻ đi"],
                sellerTasks: [],
                dialogueFlow: [] // 简化为与情景2类似结构
            }
        };

        // Firebase 引用
        let roomRef = null;
        let usersRef = null;
        let rolesRef = null;
        let messagesRef = null;
        let currentUserRef = null;
        let scenarioRef = null;
        let stepRef = null;

        // 初始化应用
        function initApp() {
            console.log("初始化应用...");
            
            // 设置 Firebase 连接状态监听
            const connectedRef = database.ref(".info/connected");
            connectedRef.on("value", function(snap) {
                if (snap.val() === true) {
                    updateFirebaseStatus(true);
                    console.log("已连接到 Firebase");
                } else {
                    updateFirebaseStatus(false);
                    console.log("已断开与 Firebase 的连接");
                }
            });

            // 设置事件监听器
            setupEventListeners();
            
            // 尝试从本地存储恢复会话
            restoreSession();
            
            // 渲染情景列表
            renderScenarioList();
            
            console.log("应用初始化完成");
        }

        // 渲染情景列表
        function renderScenarioList() {
            scenarioList.innerHTML = '';
            
            Object.values(scenarios).forEach(scenario => {
                const scenarioCard = document.createElement('div');
                scenarioCard.className = 'scenario-card';
                scenarioCard.dataset.id = scenario.id;
                
                scenarioCard.innerHTML = `
                    <div class="scenario-title">${scenario.id}. ${scenario.title}</div>
                    <div class="scenario-fruits">${scenario.fruits}</div>
                    <div class="scenario-tasks">${scenario.description}</div>
                `;
                
                scenarioCard.addEventListener('click', () => {
                    if (!currentUser.role) {
                        alert("请先选择角色 / Vui lòng chọn vai trò trước");
                        return;
                    }
                    
                    selectScenario(scenario.id);
                });
                
                scenarioList.appendChild(scenarioCard);
            });
        }

        // 设置事件监听器
        function setupEventListeners() {
            // 加入房间按钮
            joinRoomBtn.addEventListener('click', joinRoom);
            
            // 离开房间按钮
            leaveRoomBtn.addEventListener('click', leaveRoom);
            
            // 角色选择卡片
            buyerRoleCard.addEventListener('click', () => selectRole('buyer'));
            sellerRoleCard.addEventListener('click', () => selectRole('seller'));
        }

        // 更新 Firebase 连接状态显示
        function updateFirebaseStatus(isConnected) {
            const statusIcon = firebaseStatus.querySelector('i');
            const statusText = firebaseStatus.querySelector('span');
            
            if (isConnected) {
                statusIcon.style.color = '#4caf50';
                statusText.textContent = "连接状态: 已连接 / Trạng thái: Đã kết nối";
            } else {
                statusIcon.style.color = '#f44336';
                statusText.textContent = "连接状态: 已断开 / Trạng thái: Đã ngắt kết nối";
            }
        }

        // 从本地存储恢复会话
        function restoreSession() {
            const savedUser = localStorage.getItem('chineseLearningUser');
            const savedRoom = localStorage.getItem('chineseLearningRoom');
            
            if (savedUser && savedRoom) {
                try {
                    const userData = JSON.parse(savedUser);
                    const roomData = JSON.parse(savedRoom);
                    
                    // 填充输入框
                    roomCodeInput.value = roomData.code;
                    userNameInput.value = userData.name;
                    
                    console.log("从本地存储恢复会话:", userData, roomData);
                } catch (e) {
                    console.error("恢复会话时出错:", e);
                }
            }
        }

        // 保存会话到本地存储
        function saveSession() {
            localStorage.setItem('chineseLearningUser', JSON.stringify(currentUser));
            localStorage.setItem('chineseLearningRoom', JSON.stringify({ code: currentRoom.code }));
        }

        // 清除本地存储
        function clearSession() {
            localStorage.removeItem('chineseLearningUser');
            localStorage.removeItem('chineseLearningRoom');
        }

        // 加入房间
        function joinRoom() {
            const roomCode = roomCodeInput.value.trim().toUpperCase();
            const userName = userNameInput.value.trim();
            
            if (!roomCode) {
                alert("请输入房间号 / Vui lòng nhập mã phòng");
                roomCodeInput.focus();
                return;
            }
            
            if (!userName) {
                alert("请输入用户名 / Vui lòng nhập tên người dùng");
                userNameInput.focus();
                return;
            }
            
            if (roomCode.length < 2) {
                alert("房间号至少需要2个字符 / Mã phòng cần ít nhất 2 ký tự");
                roomCodeInput.focus();
                return;
            }
            
            // 禁用加入按钮
            joinRoomBtn.disabled = true;
            joinRoomBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>正在加入... / Đang tham gia...</span>';
            
            // 生成用户ID
            const userId = generateUserId();
            
            // 设置当前用户
            currentUser = {
                id: userId,
                name: userName,
                role: null,
                roomCode: roomCode
            };
            
            // 设置当前房间
            currentRoom.code = roomCode;
            
            // 保存会话
            saveSession();
            
            // 设置 Firebase 引用
            setupFirebaseRefs(roomCode, userId);
            
            // 加入房间
            joinRoomInFirebase(userId, userName);
        }

        // 生成用户ID
        function generateUserId() {
            return 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // 设置 Firebase 引用
        function setupFirebaseRefs(roomCode, userId) {
            roomRef = database.ref('rooms/' + roomCode);
            usersRef = roomRef.child('users');
            rolesRef = roomRef.child('roles');
            messagesRef = roomRef.child('messages');
            scenarioRef = roomRef.child('scenario');
            stepRef = roomRef.child('step');
            currentUserRef = usersRef.child(userId);
            
            // 监听房间数据变化
            setupRoomListeners();
        }

        // 设置房间监听器
        function setupRoomListeners() {
            // 监听用户列表变化
            usersRef.on('value', function(snapshot) {
                const users = snapshot.val() || {};
                currentRoom.users = users;
                updateUserList(users);
                updateRoleAvailability(users);
            });
            
            // 监听角色分配变化
            rolesRef.on('value', function(snapshot) {
                const roles = snapshot.val() || { buyer: null, seller: null };
                currentRoom.roles = roles;
                updateRoleSelectionUI(roles);
            });
            
            // 监听消息变化
            messagesRef.limitToLast(50).on('value', function(snapshot) {
                const messages = snapshot.val() || {};
                currentRoom.messages = Object.values(messages);
                updateChatMessages(messages);
            });
            
            // 监听情景变化
            scenarioRef.on('value', function(snapshot) {
                const scenarioId = snapshot.val();
                currentRoom.currentScenario = scenarioId;
                updateScenarioSelection(scenarioId);
                
                if (scenarioId && currentUser.role) {
                    // 如果有情景且用户已选择角色，显示对话选项
                    updateDialogueOptions();
                }
            });
            
            // 监听步骤变化
            stepRef.on('value', function(snapshot) {
                const step = snapshot.val() || 0;
                currentRoom.currentStep = step;
                
                if (currentRoom.currentScenario && currentUser.role) {
                    // 更新对话选项
                    updateDialogueOptions();
                }
            });
        }

        // 在 Firebase 中加入房间
        function joinRoomInFirebase(userId, userName) {
            // 设置用户数据
            currentUserRef.set({
                name: userName,
                role: null,
                joinedAt: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
                // 设置断开连接时自动删除用户
                currentUserRef.onDisconnect().remove();
                
                // 更新UI
                updateUIAfterJoining();
                
                console.log("成功加入房间:", currentRoom.code);
            }).catch((error) => {
                console.error("加入房间时出错:", error);
                alert("加入房间时出错 / Lỗi khi tham gia phòng: " + error.message);
                
                // 重新启用加入按钮
                joinRoomBtn.disabled = false;
                joinRoomBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i><span>进入教室 / Vào lớp học</span>';
            });
        }

        // 加入房间后更新UI
        function updateUIAfterJoining() {
            // 隐藏房间输入面板，显示角色选择面板
            roomInputPanel.classList.add('hidden');
            roleSelectionPanel.classList.remove('hidden');
            userListPanel.classList.remove('hidden');
            
            // 隐藏等待面板，显示聊天面板
            waitingPanel.classList.add('hidden');
            chatPanel.classList.remove('hidden');
            
            // 更新房间代码显示
            currentRoomCode.textContent = currentRoom.code;
            
            // 更新聊天副标题
            chatSubtitle.textContent = `房间: ${currentRoom.code} - 请选择角色 / Phòng: ${currentRoom.code} - Vui lòng chọn vai trò`;
            
            // 重新启用加入按钮
            joinRoomBtn.disabled = false;
            joinRoomBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i><span>进入教室 / Vào lớp học</span>';
            
            // 添加系统消息
            addSystemMessage(`用户 "${currentUser.name}" 加入了房间 / Người dùng "${currentUser.name}" đã tham gia phòng`);
        }

        // 离开房间
        function leaveRoom() {
            if (!confirm("确定要离开房间吗？ / Bạn có chắc chắn muốn rời phòng không?")) {
                return;
            }
            
            // 移除用户角色
            if (currentUser.role) {
                releaseRole(currentUser.role);
            }
            
            // 从 Firebase 移除用户
            if (currentUserRef) {
                currentUserRef.remove();
            }
            
            // 重置应用状态
            resetApp();
            
            // 清除本地存储
            clearSession();
            
            console.log("已离开房间");
        }

        // 重置应用状态
        function resetApp() {
            // 移除 Firebase 监听器
            if (usersRef) usersRef.off();
            if (rolesRef) rolesRef.off();
            if (messagesRef) messagesRef.off();
            if (scenarioRef) scenarioRef.off();
            if (stepRef) stepRef.off();
            
            // 重置引用
            roomRef = null;
            usersRef = null;
            rolesRef = null;
            messagesRef = null;
            scenarioRef = null;
            stepRef = null;
            currentUserRef = null;
            
            // 重置状态
            currentUser = { id: null, name: null, role: null, roomCode: null };
            currentRoom = { 
                code: null, 
                users: {}, 
                roles: { buyer: null, seller: null }, 
                messages: [],
                currentScenario: null,
                currentStep: 0
            };
            
            // 重置UI
            roomInputPanel.classList.remove('hidden');
            roleSelectionPanel.classList.add('hidden');
            userListPanel.classList.add('hidden');
            chatPanel.classList.add('hidden');
            waitingPanel.classList.remove('hidden');
            dialogueOptions.classList.add('hidden');
            scenarioSelection.classList.add('hidden');
            
            // 清空聊天消息
            chatMessages.innerHTML = `
                <div class="message message-system">
                    <div class="message-content">欢迎来到中文学习互动教室！请先加入房间并选择角色和情景。</div>
                    <div class="message-translation">Chào mừng đến với lớp học tiếng Trung tương tác! Hãy tham gia phòng và chọn vai trò, tình huống trước.</div>
                </div>
            `;
            
            // 清空用户列表
            userList.innerHTML = '';
            
            // 清空选项
            optionsContainer.innerHTML = '';
            
            // 重置角色选择
            resetRoleSelectionUI();
            
            // 重置房间代码显示
            currentRoomCode.textContent = "---";
        }

        // 选择角色
        function selectRole(role) {
            if (!currentUser.id || !currentRoom.code) {
                alert("请先加入房间 / Vui lòng tham gia phòng trước");
                return;
            }
            
            // 检查角色是否已被选择
            if (currentRoom.roles[role]) {
                alert("该角色已被选择 / Vai trò này đã được chọn");
                return;
            }
            
            // 如果用户已有角色，先释放
            if (currentUser.role) {
                releaseRole(currentUser.role);
            }
            
            // 在 Firebase 中分配角色
            assignRoleInFirebase(role);
        }

        // 在 Firebase 中分配角色
        function assignRoleInFirebase(role) {
            // 更新角色分配
            rolesRef.child(role).set(currentUser.id)
                .then(() => {
                    // 设置断开连接时自动释放角色
                    rolesRef.child(role).onDisconnect().remove();
                    
                    // 更新用户角色
                    currentUserRef.update({ role: role })
                        .then(() => {
                            currentUser.role = role;
                            updateUIAfterRoleSelection(role);
                            addSystemMessage(`用户 "${currentUser.name}" 选择了 ${role === 'buyer' ? '买家' : '卖家'} 角色 / Người dùng "${currentUser.name}" đã chọn vai trò ${role === 'buyer' ? 'người mua' : 'người bán'}`);
                            
                            // 显示情景选择
                            scenarioSelection.classList.remove('hidden');
                        });
                })
                .catch((error) => {
                    console.error("分配角色时出错:", error);
                    alert("分配角色时出错 / Lỗi khi phân vai trò: " + error.message);
                });
        }

        // 释放角色
        function releaseRole(role) {
            if (currentRoom.roles[role] === currentUser.id) {
                rolesRef.child(role).remove();
                currentUserRef.update({ role: null });
                currentUser.role = null;
            }
        }

        // 选择角色后更新UI
        function updateUIAfterRoleSelection(role) {
            // 更新角色卡片选择状态
            updateRoleSelectionUI(currentRoom.roles);
            
            // 更新聊天副标题
            const roleName = role === 'buyer' ? '买家 (Người mua)' : '卖家 (Người bán)';
            chatSubtitle.textContent = `房间: ${currentRoom.code} - 您的角色: ${roleName} / Phòng: ${currentRoom.code} - Vai trò của bạn: ${roleName}`;
            
            // 添加角色提示消息
            if (role === 'buyer') {
                addSystemMessage("您的角色是买家。请记住: 必须买至少3种水果；必须讲价；付款时给大面额钞票。 / Vai trò của bạn là người mua. Hãy nhớ: Mua ít nhất 3 loại; phải trả giá; đưa tiền mệnh giá lớn.");
            } else {
                addSystemMessage("您的角色是卖家。请记住: 必须推荐其他水果；态度热情；感谢顾客。 / Vai trò của bạn là người bán. Hãy nhớ: Gợi ý thêm; nhiệt tình; cảm ơn khách hàng.");
            }
        }

        // 选择情景
        function selectScenario(scenarioId) {
            if (!currentUser.id || !currentUser.role) {
                alert("请先选择角色 / Vui lòng chọn vai trò trước");
                return;
            }
            
            // 在 Firebase 中设置情景
            scenarioRef.set(scenarioId)
                .then(() => {
                    // 重置步骤
                    stepRef.set(0);
                    
                    // 更新情景选择UI
                    updateScenarioSelection(scenarioId);
                    
                    // 显示对话选项
                    dialogueOptions.classList.remove('hidden');
                    
                    // 添加系统消息
                    const scenario = scenarios[scenarioId];
                    addSystemMessage(`已选择情景: ${scenario.title} / Đã chọn tình huống: ${scenario.title}`);
                    addSystemMessage(`水果: ${scenario.fruits} / Trái cây: ${scenario.fruits}`);
                    
                    if (currentUser.role === 'buyer' && scenario.buyerTasks.length > 0) {
                        addSystemMessage(`买家任务: ${scenario.buyerTasks[0]} / Nhiệm vụ người mua: ${scenario.buyerTasks[0]}`);
                    }
                    
                    if (currentUser.role === 'seller' && scenario.sellerTasks.length > 0) {
                        addSystemMessage(`卖家任务: ${scenario.sellerTasks[0]} / Nhiệm vụ người bán: ${scenario.sellerTasks[0]}`);
                    }
                })
                .catch((error) => {
                    console.error("选择情景时出错:", error);
                    alert("选择情景时出错 / Lỗi khi chọn tình huống: " + error.message);
                });
        }

        // 更新用户列表
        function updateUserList(users) {
            userList.innerHTML = '';
            
            Object.entries(users).forEach(([userId, userData]) => {
                const userItem = document.createElement('div');
                userItem.className = 'user-item';
                
                const roleText = userData.role === 'buyer' 
                    ? '买家 / Người mua' 
                    : userData.role === 'seller' 
                        ? '卖家 / Người bán' 
                        : '未选择 / Chưa chọn';
                
                const isCurrentUser = userId === currentUser.id;
                const userName = isCurrentUser ? `${userData.name} (我 / Tôi)` : userData.name;
                
                userItem.innerHTML = `
                    <div class="user-avatar" style="background-color: ${isCurrentUser ? '#d32f2f' : '#1976d2'}">
                        ${userData.name.charAt(0).toUpperCase()}
                    </div>
                    <div class="user-info">
                        <div class="user-name">${userName}</div>
                        <div class="user-role">${roleText}</div>
                    </div>
                `;
                
                userList.appendChild(userItem);
            });
        }

        // 更新角色可用性
        function updateRoleAvailability(users) {
            // 计算每个角色的用户数
            let buyerCount = 0;
            let sellerCount = 0;
            
            Object.values(users).forEach(user => {
                if (user.role === 'buyer') buyerCount++;
                if (user.role === 'seller') sellerCount++;
            });
            
            // 更新状态显示
            if (buyerCount > 0) {
                buyerStatus.textContent = "已选 / Đã chọn";
                buyerStatus.className = "role-status status-taken";
            } else {
                buyerStatus.textContent = "可选 / Có thể chọn";
                buyerStatus.className = "role-status status-available";
            }
            
            if (sellerCount > 0) {
                sellerStatus.textContent = "已选 / Đã chọn";
                sellerStatus.className = "role-status status-taken";
            } else {
                sellerStatus.textContent = "可选 / Có thể chọn";
                sellerStatus.className = "role-status status-available";
            }
        }

        // 更新角色选择UI
        function updateRoleSelectionUI(roles) {
            // 重置两个卡片
            buyerRoleCard.classList.remove('selected', 'disabled');
            sellerRoleCard.classList.remove('selected', 'disabled');
            
            // 更新买家卡片
            if (roles.buyer) {
                if (roles.buyer === currentUser.id) {
                    buyerRoleCard.classList.add('selected');
                } else {
                    buyerRoleCard.classList.add('disabled');
                }
            }
            
            // 更新卖家卡片
            if (roles.seller) {
                if (roles.seller === currentUser.id) {
                    sellerRoleCard.classList.add('selected');
                } else {
                    sellerRoleCard.classList.add('disabled');
                }
            }
        }

        // 更新情景选择UI
        function updateScenarioSelection(scenarioId) {
            // 重置所有情景卡片
            document.querySelectorAll('.scenario-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // 选择当前情景
            if (scenarioId) {
                const selectedCard = document.querySelector(`.scenario-card[data-id="${scenarioId}"]`);
                if (selectedCard) {
                    selectedCard.classList.add('selected');
                }
            }
        }

        // 重置角色选择UI
        function resetRoleSelectionUI() {
            buyerRoleCard.classList.remove('selected', 'disabled');
            sellerRoleCard.classList.remove('selected', 'disabled');
            
            buyerStatus.textContent = "可选 / Có thể chọn";
            buyerStatus.className = "role-status status-available";
            
            sellerStatus.textContent = "可选 / Có thể chọn";
            sellerStatus.className = "role-status status-available";
        }

        // 更新对话选项
        function updateDialogueOptions() {
            const scenarioId = currentRoom.currentScenario;
            const step = currentRoom.currentStep || 0;
            
            if (!scenarioId || !scenarios[scenarioId]) {
                optionsContainer.innerHTML = '<div class="option-btn" style="text-align: center; grid-column: 1 / -1;">请等待选择情景 / Vui lòng chờ chọn tình huống</div>';
                return;
            }
            
            const scenario = scenarios[scenarioId];
            const dialogueFlow = scenario.dialogueFlow;
            
            if (!dialogueFlow || dialogueFlow.length === 0) {
                optionsContainer.innerHTML = '<div class="option-btn" style="text-align: center; grid-column: 1 / -1;">此情景暂无对话数据 / Tình huống này chưa có dữ liệu hội thoại</div>';
                return;
            }
            
            if (step >= dialogueFlow.length) {
                optionsContainer.innerHTML = '<div class="option-btn" style="text-align: center; grid-column: 1 / -1;">对话已完成！请选择新情景 / Hội thoại đã hoàn thành! Vui lòng chọn tình huống mới</div>';
                return;
            }
            
            const currentStepData = dialogueFlow[step];
            
            // 检查当前是否是当前用户的回合
            if (currentStepData.speaker !== currentUser.role) {
                optionsContainer.innerHTML = `<div class="option-btn" style="text-align: center; grid-column: 1 / -1;">请等待 ${currentStepData.speaker === 'buyer' ? '买家' : '卖家'} 说话 / Vui lòng chờ ${currentStepData.speaker === 'buyer' ? 'người mua' : 'người bán'} nói</div>`;
                return;
            }
            
            // 显示当前步骤的选项
            optionsContainer.innerHTML = '';
            
            // 添加类别标题
            const categoryElement = document.createElement('div');
            categoryElement.className = 'dialogue-category';
            categoryElement.textContent = currentStepData.category;
            optionsContainer.appendChild(categoryElement);
            
            // 添加选项按钮
            currentStepData.options.forEach((option, index) => {
                const optionBtn = document.createElement('button');
                optionBtn.className = 'option-btn';
                optionBtn.dataset.index = index;
                
                optionBtn.innerHTML = `
                    <div class="option-text">${option.chinese}</div>
                    <div class="option-translation">${option.vietnamese}</div>
                `;
                
                optionBtn.addEventListener('click', () => {
                    selectDialogueOption(option);
                });
                
                optionsContainer.appendChild(optionBtn);
            });
        }

        // 选择对话选项
        function selectDialogueOption(option) {
            if (!currentRoom.currentScenario) {
                alert("请先选择情景 / Vui lòng chọn tình huống trước");
                return;
            }
            
            // 发送消息
            sendDialogueMessage(option.chinese, option.vietnamese);
            
            // 更新步骤
            const nextStep = (currentRoom.currentStep || 0) + 1;
            stepRef.set(nextStep);
        }

        // 发送对话消息
        function sendDialogueMessage(chinese, vietnamese) {
            // 创建消息对象
            const message = {
                sender: currentUser.role,
                senderName: currentUser.name,
                chinese: chinese,
                vietnamese: vietnamese,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };
            
            // 发送到 Firebase
            messagesRef.push(message)
                .catch((error) => {
                    console.error("发送消息时出错:", error);
                    alert("发送消息时出错 / Lỗi khi gửi tin nhắn: " + error.message);
                });
        }

        // 更新聊天消息
        function updateChatMessages(messages) {
            // 清空聊天消息（除了系统欢迎消息）
            const welcomeMessage = chatMessages.querySelector('.message-system');
            chatMessages.innerHTML = '';
            if (welcomeMessage) {
                chatMessages.appendChild(welcomeMessage);
            }
            
            // 按时间戳排序消息
            const sortedMessages = Object.entries(messages)
                .map(([id, msg]) => ({ id, ...msg }))
                .sort((a, b) => a.timestamp - b.timestamp);
            
            // 添加消息到聊天界面
            sortedMessages.forEach(msg => {
                if (msg.sender === 'buyer' || msg.sender === 'seller') {
                    addMessageToChat(msg.sender, msg.senderName, msg.chinese, msg.vietnamese, msg.timestamp);
                } else {
                    // 系统消息
                    addSystemMessage(msg.chinese + (msg.vietnamese ? " / " + msg.vietnamese : ""));
                }
            });
            
            // 滚动到底部
            scrollChatToBottom();
        }

        // 添加消息到聊天界面
        function addMessageToChat(senderRole, senderName, chinese, vietnamese, timestamp) {
            const messageDiv = document.createElement('div');
            
            // 设置消息类
            let messageClass = 'message ';
            if (senderRole === 'buyer') {
                messageClass += 'message-buyer';
            } else if (senderRole === 'seller') {
                messageClass += 'message-seller';
            } else {
                messageClass += 'message-system';
            }
            
            // 格式化时间
            const time = timestamp ? new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            // 设置发送者显示名称
            const senderDisplayName = senderName === currentUser.name ? `${senderName} (我 / Tôi)` : senderName;
            const roleDisplayName = senderRole === 'buyer' ? '买家 / Người mua' : '卖家 / Người bán';
            
            messageDiv.className = messageClass;
            messageDiv.innerHTML = `
                <div class="message-sender ${senderRole}">${senderDisplayName} (${roleDisplayName})</div>
                <div class="message-content">${escapeHtml(chinese)}</div>
                <div class="message-translation">${escapeHtml(vietnamese)}</div>
                <div class="message-time">${time}</div>
            `;
            
            chatMessages.appendChild(messageDiv);
        }

        // 添加系统消息
        function addSystemMessage(text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message message-system';
            
            // 分割中越双语文本
            const parts = text.split(' / ');
            const chineseText = parts[0] || text;
            const vietnameseText = parts[1] || text;
            
            messageDiv.innerHTML = `
                <div class="message-content">${escapeHtml(chineseText)}</div>
                <div class="message-translation">${escapeHtml(vietnameseText)}</div>
            `;
            
            chatMessages.appendChild(messageDiv);
            scrollChatToBottom();
        }

        // 滚动聊天到底部
        function scrollChatToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // 转义 HTML 特殊字符
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // 当 DOM 加载完成后初始化应用
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
        });
    </script>
</body>
</html>
