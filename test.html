<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lớp học tiếng Trung: Mua bán trái cây (Online)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- FIX 1: Dùng phiên bản Compat để tương thích với code kiểu cũ cho dễ hiểu -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
        /* GIỮ NGUYÊN CSS CŨ CỦA BẠN, CÓ THÊM MỘT CHÚT CHO PHẦN CHỌN PHÒNG */
        :root {
            --primary: #ff7b9c;
            --primary-light: #ffc8dd;
            --secondary: #a7c957;
            --secondary-light: #d8f3dc;
            --accent: #ffb703;
            --text: #333;
            --text-light: #666;
            --background: #f9f7f3;
            --card: #ffffff;
            --shadow: rgba(0, 0, 0, 0.1);
            --border-radius: 20px;
            --font-main: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --font-cute: 'Comic Sans MS', 'Chalkboard SE', cursive;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-main);
            background-color: var(--background);
            color: var(--text);
            line-height: 1.6;
            padding: 10px;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffc8dd' fill-opacity='0.2'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        .container { max-width: 1200px; margin: 0 auto; }

        header {
            text-align: center;
            padding: 20px 10px;
            margin-bottom: 20px;
            background-color: var(--card);
            border-radius: var(--border-radius);
            box-shadow: 0 8px 20px var(--shadow);
            border: 5px dashed var(--primary-light);
        }

        h1 { color: var(--primary); font-size: 2.5rem; margin-bottom: 10px; font-family: var(--font-cute); text-shadow: 3px 3px 0 var(--primary-light); }
        .subtitle { color: var(--secondary); font-size: 1.2rem; margin-bottom: 15px; }

        /* CSS CHO PHẦN NHẬP MÃ PHÒNG */
        .room-setup {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
            border: 2px solid var(--accent);
        }
        .room-input {
            padding: 10px;
            font-size: 1.2rem;
            border-radius: 10px;
            border: 1px solid #ddd;
            width: 150px;
            text-align: center;
            text-transform: uppercase;
        }
        .join-btn {
            padding: 10px 20px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: bold;
        }

        .main-content { display: flex; flex-direction: column; gap: 20px; }
        @media (min-width: 768px) {
            .main-content { flex-direction: row; }
            .left-panel { flex: 1; }
            .right-panel { flex: 2; }
        }

        .panel {
            background-color: var(--card);
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: 0 8px 20px var(--shadow);
            margin-bottom: 20px;
        }

        h2 { color: var(--primary); font-size: 1.8rem; margin-bottom: 20px; border-bottom: 3px dotted var(--primary-light); font-family: var(--font-cute); }
        h3 { color: var(--secondary); margin: 15px 0 10px; font-size: 1.3rem; }

        .role-selection { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .role-btn {
            flex: 1; min-width: 140px; padding: 15px; border: none; border-radius: 15px;
            background-color: var(--primary-light); color: var(--text); font-size: 1.1rem;
            cursor: pointer; transition: all 0.3s; display: flex; flex-direction: column;
            align-items: center; gap: 8px; font-weight: bold;
        }
        .role-btn:hover { transform: translateY(-5px); box-shadow: 0 10px 15px var(--shadow); }
        .role-btn.active { background-color: var(--primary); color: white; }
        .role-btn:disabled { background-color: #ccc; cursor: not-allowed; transform: none; }

        .chat-container { display: flex; flex-direction: column; height: 500px; }
        .chat-header { display: flex; justify-content: space-between; padding-bottom: 15px; border-bottom: 2px solid var(--primary-light); margin-bottom: 15px; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 15px; background-color: #f9f9f9; border-radius: 15px; margin-bottom: 15px; display: flex; flex-direction: column; gap: 15px; }
        
        .message { max-width: 80%; padding: 15px; border-radius: 20px; position: relative; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .message-me { align-self: flex-end; background-color: var(--primary); color: white; border-bottom-right-radius: 5px; }
        .message-other { align-self: flex-start; background-color: var(--secondary); color: white; border-bottom-left-radius: 5px; }
        .message-system { align-self: center; background-color: #e0e0e0; color: var(--text); font-style: italic; text-align: center; max-width: 90%; font-size: 0.9rem; }

        .chat-input-area { display: flex; gap: 10px; }
        .chat-input { flex: 1; padding: 15px; border: 2px solid var(--primary-light); border-radius: 15px; font-size: 1rem; }
        .send-btn { padding: 0 25px; background-color: var(--primary); color: white; border: none; border-radius: 15px; cursor: pointer; font-size: 1.1rem; }
        
        .firebase-status { padding: 10px; border-radius: 10px; text-align: center; margin-top: 10px; font-size: 0.9rem; }
        .connected { background-color: #d4edda; color: #155724; }
        .disconnected { background-color: #f8d7da; color: #721c24; }
        
        /* Ẩn các phần chưa cần thiết khi chưa vào phòng */
        #gameArea { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-apple-alt"></i> Lớp học tiếng Trung: Mua bán trái cây</h1>
            <p class="subtitle">Kết nối trực tuyến - Tương tác thời gian thực</p>
        </header>
        
        <!-- BƯỚC 1: NHẬP MÃ PHÒNG -->
        <div class="room-setup" id="roomSetup">
            <h3><i class="fas fa-door-open"></i> Bước 1: Vào lớp học</h3>
            <p>Hai học viên hãy nhập chung một mã phòng (Ví dụ: BAN1, NHO1) để gặp nhau.</p>
            <br>
            <input type="text" id="roomIdInput" class="room-input" placeholder="Mã phòng..." maxlength="10">
            <button id="joinRoomBtn" class="join-btn">Vào Lớp</button>
        </div>

        <!-- BƯỚC 2: KHU VỰC TRÒ CHƠI (Ẩn đi cho đến khi vào phòng) -->
        <div class="main-content" id="gameArea">
            <div class="left-panel">
                <div class="panel">
                    <h2><i class="fas fa-user"></i> Bước 2: Chọn vai trò</h2>
                    <p style="margin-bottom: 10px; font-style: italic; color: #666;">Ai nhanh tay người đó được chọn trước!</p>
                    <div class="role-selection">
                        <button class="role-btn" id="buyerBtn">
                            <i class="fas fa-shopping-basket"></i>
                            <span>Người mua (A)</span>
                            <span id="buyerStatus" style="font-size: 0.8rem">(Trống)</span>
                        </button>
                        <button class="role-btn" id="sellerBtn">
                            <i class="fas fa-store"></i>
                            <span>Người bán (B)</span>
                            <span id="sellerStatus" style="font-size: 0.8rem">(Trống)</span>
                        </button>
                    </div>
                    <div id="roleInstructions"></div>
                </div>
                
                <div class="firebase-status" id="firebaseStatus">Đang kết nối...</div>
            </div>
            
            <div class="right-panel">
                <div class="panel">
                    <h2><i class="fas fa-comments"></i> Hội thoại trực tiếp</h2>
                    <div class="chat-container">
                        <div class="chat-header">
                            <div class="chat-info">Phòng: <strong id="displayRoomId">---</strong></div>
                            <div class="chat-info">Bạn là: <strong id="displayMyRole" style="color:var(--primary)">Chưa chọn</strong></div>
                        </div>
                        
                        <div class="chat-messages" id="chatMessages">
                            <div class="message message-system">
                                Hãy chọn vai trò để bắt đầu chat với bạn cùng lớp!
                            </div>
                        </div>
                        
                        <div class="chat-input-area">
                            <input type="text" class="chat-input" id="chatInput" placeholder="Nhập tin nhắn..." disabled>
                            <button class="send-btn" id="sendBtn" disabled><i class="fas fa-paper-plane"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>© 2024 - Hệ thống lớp học tương tác Realtime</p>
        </footer>
    </div>

    <script>
        // --- 1. CẤU HÌNH FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyDcsk8X1rFd1qMd1W9510-ZKFlSfZUUKV8",
            authDomain: "lop-hoc-tuong-tac-26351.firebaseapp.com",
            databaseURL: "https://lop-hoc-tuong-tac-26351-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "lop-hoc-tuong-tac-26351",
            storageBucket: "lop-hoc-tuong-tac-26351.firebasestorage.app",
            messagingSenderId: "854589974779",
            appId: "1:854589974779:web:038a2f3d54cb443a6f685e"
        };

        // Khởi tạo Firebase (Dùng cú pháp compat để tương thích code cũ)
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // --- 2. BIẾN TOÀN CỤC ---
        let currentRoomId = null;
        let myRole = null; // 'buyer' hoặc 'seller'

        // DOM Elements
        const roomSetupDiv = document.getElementById('roomSetup');
        const gameAreaDiv = document.getElementById('gameArea');
        const roomIdInput = document.getElementById('roomIdInput');
        const joinRoomBtn = document.getElementById('joinRoomBtn');
        const displayRoomId = document.getElementById('displayRoomId');
        
        const buyerBtn = document.getElementById('buyerBtn');
        const sellerBtn = document.getElementById('sellerBtn');
        const buyerStatus = document.getElementById('buyerStatus');
        const sellerStatus = document.getElementById('sellerStatus');
        const displayMyRole = document.getElementById('displayMyRole');

        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');
        const firebaseStatus = document.getElementById('firebaseStatus');

        // --- 3. LOGIC VÀO PHÒNG ---
        joinRoomBtn.addEventListener('click', () => {
            const roomCode = roomIdInput.value.trim().toUpperCase();
            if (roomCode.length < 2) {
                alert("Vui lòng nhập mã phòng (ít nhất 2 ký tự)");
                return;
            }
            enterRoom(roomCode);
        });

        function enterRoom(roomCode) {
            currentRoomId = roomCode;
            roomSetupDiv.style.display = 'none';
            gameAreaDiv.style.display = 'flex';
            displayRoomId.textContent = roomCode;

            // Kết nối Firebase: Lắng nghe trạng thái vai trò trong phòng này
            setupRoleListeners();
            // Kết nối Firebase: Lắng nghe tin nhắn
            setupChatListener();
            
            // Theo dõi kết nối mạng
            const connectedRef = database.ref(".info/connected");
            connectedRef.on("value", (snap) => {
                if (snap.val() === true) {
                    firebaseStatus.textContent = "Đã kết nối mạng";
                    firebaseStatus.className = "firebase-status connected";
                } else {
                    firebaseStatus.textContent = "Mất kết nối!";
                    firebaseStatus.className = "firebase-status disconnected";
                }
            });
        }

        // --- 4. LOGIC CHỌN VAI TRÒ (SYNC REALTIME) ---
        function setupRoleListeners() {
            const roomRef = database.ref('rooms/' + currentRoomId + '/roles');

            // Lắng nghe xem vai trò nào đã bị chọn
            roomRef.on('value', (snapshot) => {
                const roles = snapshot.val() || {};
                
                // Cập nhật nút Người Mua
                if (roles.buyer) {
                    buyerBtn.disabled = true;
                    buyerStatus.textContent = "(Đã có người chọn)";
                    buyerBtn.style.opacity = "0.6";
                    if (myRole === 'buyer') {
                        buyerBtn.classList.add('active'); // Nếu là mình chọn thì sáng lên
                        buyerBtn.style.opacity = "1";
                    }
                } else {
                    buyerBtn.disabled = false;
                    buyerStatus.textContent = "(Trống)";
                    buyerBtn.classList.remove('active');
                    buyerBtn.style.opacity = "1";
                }

                // Cập nhật nút Người Bán
                if (roles.seller) {
                    sellerBtn.disabled = true;
                    sellerStatus.textContent = "(Đã có người chọn)";
                    sellerBtn.style.opacity = "0.6";
                    if (myRole === 'seller') {
                        sellerBtn.classList.add('active');
                        sellerBtn.style.opacity = "1";
                    }
                } else {
                    sellerBtn.disabled = false;
                    sellerStatus.textContent = "(Trống)";
                    sellerBtn.classList.remove('active');
                    sellerBtn.style.opacity = "1";
                }
            });
        }

        // Hàm xử lý khi bấm nút chọn vai trò
        buyerBtn.addEventListener('click', () => selectRole('buyer'));
        sellerBtn.addEventListener('click', () => selectRole('seller'));

        function selectRole(role) {
            if (myRole) return; // Đã chọn rồi thì thôi

            // Ghi vào Database: "Tôi xí chỗ này nhé"
            database.ref('rooms/' + currentRoomId + '/roles/' + role).set("taken", (error) => {
                if (error) {
                    alert("Lỗi: Không thể chọn vai trò này.");
                } else {
                    // Thành công
                    myRole = role;
                    displayMyRole.textContent = role === 'buyer' ? "Người Mua (A)" : "Người Bán (B)";
                    
                    // Mở khóa ô chat
                    chatInput.disabled = false;
                    sendBtn.disabled = false;
                    
                    // Thông báo hệ thống
                    addSystemMessage(`Bạn đã chọn là ${role === 'buyer' ? 'Người Mua' : 'Người Bán'}. Hãy bắt đầu chào hỏi!`);
                    
                    // Xóa chọn vai trò khi thoát trang (disconnect)
                    database.ref('rooms/' + currentRoomId + '/roles/' + role).onDisconnect().remove();
                }
            });
        }

        // --- 5. LOGIC CHAT (SYNC REALTIME) ---
        function setupChatListener() {
            const messagesRef = database.ref('rooms/' + currentRoomId + '/messages');
            
            // Xóa tin nhắn cũ khi vào lại (tùy chọn, ở đây mình giữ lại để xem lịch sử)
            // messagesRef.remove(); 

            messagesRef.on('child_added', (snapshot) => {
                const msg = snapshot.val();
                displayMessage(msg);
            });
        }

        sendBtn.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        function sendMessage() {
            const text = chatInput.value.trim();
            if (text === '' || !myRole) return;

            const msgData = {
                sender: myRole, // 'buyer' hoặc 'seller'
                text: text,
                timestamp: Date.now()
            };

            // Đẩy tin nhắn lên Firebase
            database.ref('rooms/' + currentRoomId + '/messages').push(msgData);
            chatInput.value = '';
        }

        function displayMessage(msg) {
            const msgDiv = document.createElement('div');
            
            // Xác định xem tin nhắn là của mình hay của bạn
            let className = 'message';
            if (msg.sender === myRole) {
                className += ' message-me'; // Tin mình gửi
            } else {
                className += ' message-other'; // Tin bạn gửi
            }

            msgDiv.className = className;
            msgDiv.textContent = msg.text; // Hiển thị nội dung
            
            chatMessages.appendChild(msgDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight; // Tự cuộn xuống dưới
        }

        function addSystemMessage(text) {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message message-system';
            msgDiv.textContent = text;
            chatMessages.appendChild(msgDiv);
        }

    </script>
</body>
</html>
