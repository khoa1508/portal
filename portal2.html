<script>
        // CẤU HÌNH API URL (Giữ nguyên link của bạn)
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw0UuBeAYAEUcmx81DU6S1MxpJBm_VOutbkBvTGzl__bV2FvEPAtllTcBpn0gizsWEa/exec";

        // Kiểm tra trạng thái đăng nhập khi tải trang
        document.addEventListener('DOMContentLoaded', function() {
            const isLoggedIn = localStorage.getItem('ddkLoggedIn');
            if (isLoggedIn === 'true') {
                showMainContent();
            }
        });

        // Hàm xử lý phím Enter
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                checkCode();
            }
        }

        // --- HÀM KIỂM TRA MÃ (ĐÃ NÂNG CẤP) ---
        async function checkCode() {
            const inputEl = document.getElementById('code');
            // 1. Cắt khoảng trắng thừa ngay từ đầu vào
            const code = inputEl.value.trim(); 
            const message = document.getElementById('message');
            const loginBtn = document.getElementById('loginBtn');
            
            if (!code) {
                showMessage('Vui lòng nhập mã truy cập!', 'error');
                return;
            }

            // Hiển thị trạng thái loading
            loginBtn.innerHTML = 'ĐANG KIỂM TRA...';
            loginBtn.disabled = true;
            message.classList.add('hidden'); // Ẩn thông báo cũ

            try {
                // 2. Thêm tham số redirect: 'follow' để trình duyệt tự động đi theo link chuyển hướng của Google
                const response = await fetch(`${SCRIPT_URL}?code=${encodeURIComponent(code)}`, {
                    method: 'GET',
                    redirect: 'follow' 
                });

                // 3. Không dùng .json() ngay, mà lấy .text() trước để kiểm tra xem Server trả về cái gì
                const textResult = await response.text();
                
                // Debug: In kết quả ra màn hình console (F12) để soi lỗi
                console.log("Server trả về:", textResult);

                let data;
                try {
                    // Cố gắng chuyển đổi text sang JSON
                    data = JSON.parse(textResult);
                } catch (e) {
                    // Nếu lỗi ở đây, tức là Server trả về HTML (Lỗi quyền truy cập) chứ không phải JSON
                    throw new Error("Lỗi kết nối: Không thể đọc dữ liệu từ Server. (Khả năng do chưa set quyền 'Anyone')");
                }
                
                if (data.valid === true) {
                    // Đăng nhập thành công
                    showMessage(data.message || 'Đăng nhập thành công!', 'success');
                    localStorage.setItem('ddkLoggedIn', 'true');
                    setTimeout(showMainContent, 1000);
                } else {
                    // Đăng nhập thất bại (Sai mã)
                    showMessage(data.message || 'Mã truy cập không đúng!', 'error');
                }

            } catch (error) {
                console.error('Chi tiết lỗi:', error);
                // Hiển thị lỗi cụ thể ra màn hình để bạn biết đường sửa
                showMessage('Lỗi: ' + error.message, 'error');
            } finally {
                // Khôi phục trạng thái nút
                loginBtn.innerHTML = 'ĐĂNG NHẬP';
                loginBtn.disabled = false;
            }
        }

        // Hàm hiển thị thông báo
        function showMessage(text, type) {
            const message = document.getElementById('message');
            message.textContent = text;
            message.classList.remove('hidden');
            
            if (type === 'success') {
                message.style.color = '#10B981'; // Xanh lá
            } else {
                message.style.color = '#EF4444'; // Đỏ
            }
        }

        // Hàm hiển thị nội dung chính
        function showMainContent() {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
            
            // Xử lý link: Xóa noreferrer và thêm opener để Web Con nhận diện được Web Cha
            document.querySelectorAll('a').forEach(link => {
                link.removeAttribute('rel');
                link.setAttribute('rel', 'opener');
            });
            
            setupHoverEffects();
        }

        // Hàm đăng xuất
        function logout() {
            localStorage.removeItem('ddkLoggedIn');
            document.getElementById('mainContent').classList.add('hidden');
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('code').value = '';
            document.getElementById('message').classList.add('hidden');
        }

        // Hàm thiết lập hiệu ứng hover
        function setupHoverEffects() {
            document.querySelectorAll('.group').forEach(card => {
                const span = card.querySelector('span');
                if (span) {
                    card.addEventListener('mouseenter', () => {
                        span.style.color = 'var(--color-primary-orange)';
                    });
                    card.addEventListener('mouseleave', () => {
                        span.style.color = 'var(--color-text-medium)';
                    });
                }
            });
        }
    </script>
