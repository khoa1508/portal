<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>越南语拼写听力练习</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Mali:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Mali', cursive;
            background-color: #FFF9DE;
            color: #583101;
        }
        .card {
            background-color: #FFECD1;
            border: 2px solid #A37E58;
            box-shadow: 5px 5px 0px #A37E58;
        }
        .btn-option {
            background-color: #FFFFFF;
            border: 2px solid #A37E58;
            box-shadow: 3px 3px 0px #A37E58;
            transition: all 0.1s ease-in-out;
        }
        .btn-option:hover {
            transform: translate(2px, 2px);
            box-shadow: 1px 1px 0px #A37E58;
        }
        .btn-option:active {
            transform: translate(3px, 3px);
            box-shadow: none;
        }
        .btn-correct {
            background-color: #A7C957;
            color: white;
            border-color: #6A994E;
            box-shadow: 3px 3px 0px #6A994E !important;
        }
        .btn-wrong {
            background-color: #E56B6F;
            color: white;
            border-color: #B56576;
            box-shadow: 3px 3px 0px #B56576 !important;
        }
        .speaker-btn {
            background-color: #FFC971;
            border: 2px solid #A37E58;
            box-shadow: 3px 3px 0px #A37E58;
            transition: all 0.1s ease-in-out;
        }
        .speaker-btn:hover {
            background-color: #FFB640;
        }
        .speaker-btn:active {
            transform: translate(3px, 3px);
            box-shadow: none;
        }
        .speaker-btn:disabled {
            background-color: #D1CFC9;
            cursor: not-allowed;
            box-shadow: 3px 3px 0px #a1a1aa;
        }
        .next-btn {
            background-color: #89B0AE;
            color: white;
            border: 2px solid #55828B;
            box-shadow: 3px 3px 0px #55828B;
        }
        .next-btn:hover {
            background-color: #79A09E;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
    <div id="quiz-container" class="card w-full max-w-2xl p-6 md:p-8 rounded-2xl">
        <!-- Header -->
        <div class="text-center mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-amber-800">越南语拼写听力练习</h1>
            <p class="text-amber-700 mt-2">点击喇叭图标听单词，然后选择正确的拼写。</p>
            <p class="text-amber-700">(Nhấp vào biểu tượng loa để nghe từ, sau đó chọn cách viết đúng.)</p>
        </div>

        <!-- Quiz Area -->
        <div id="quiz-area">
            <div class="flex justify-between items-center mb-4">
                <div id="progress" class="text-lg font-semibold">问题 1 / 100</div>
                <div id="score" class="text-lg font-semibold">分数: 0</div>
            </div>

            <!-- Speaker Button -->
            <div class="flex justify-center my-8">
                <button id="speak-btn" class="speaker-btn p-4 rounded-full" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
                    </svg>
                </button>
            </div>

            <!-- Options -->
            <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Questions will be rendered here immediately -->
            </div>
            
            <!-- Feedback -->
            <div id="feedback" class="text-center mt-6 text-xl font-bold h-8"></div>
            
            <!-- Next Button -->
            <div class="flex justify-center mt-4">
                <button id="next-btn" class="next-btn py-3 px-8 rounded-lg text-lg font-bold hidden">下一题</button>
            </div>
        </div>
        
        <!-- Result Screen -->
        <div id="result-screen" class="hidden text-center">
             <h2 class="text-3xl font-bold mb-4">做得好！</h2>
             <p id="final-score" class="text-2xl mb-6">你的最终分数是：85 / 100</p>
             <button id="restart-btn" class="next-btn py-3 px-8 rounded-lg text-lg font-bold">再玩一次</button>
        </div>
    </div>

    <script>
        // --- 1. Cấu hình và Dữ liệu ---
        const words = [
            'bài báo', 'trai gái', 'sai trái', 'máy bay', 'cay cú', 'thay thế', 'chạy dài', 'khâu vá', 'chậu thau', 'trầu cau',
            'mau lẹ', 'lâu nhâu', 'đầu trâu', 'nhà lầu', 'câu cá', 'sâu xa', 'đau đầu', 'theo đuổi', 'giấy tờ', 'thấy rõ',
            'nhờ cậy', 'thầy giáo', 'tại sao', 'của cải', 'gió bụi', 'vui chơi', 'lúi húi', 'trụi lùi', 'bối rối', 'Hà Nội',
            'đòi hỏi', 'mọi nơi', 'soi thấu', 'hội chợ', 'chơi bời', 'chờ đợi', 'nghỉ ngơi', 'cứu chữa', 'hữu nghị', 'lưu ý',
            'khó ngửi', 'gửi lời', 'hiu hắt', 'chịu khó', 'tiu nghỉu', 'lêu khêu', 'leo trèo', 'lẻo đẻo', 'heo may', 'rau muống',
            'đuôi gà', 'hươu nai', 'cười tươi', 'bưởi đào', 'lưỡi trai', 'người đời', 'yêu dấu', 'nhiều điều', 'yếu đuối', 'phụ nữ',
            'nghề phụ', 'phù hợp', 'lệ phí', 'phở bò', 'chế độ', 'che chở', 'chè lá', 'va li', 'vé số', 'vệ sĩ',
            'vi mô', 'ví dụ', 'vị trí', 'vì thế', 'trẻ thơ', 'trì trệ', 'trị giá', 'xứ sở', 'nghệ sĩ', 'kỵ sĩ',
            'lo sợ', 'số đỏ', 'sơ hở', 'sơ-mi', 'giả vờ', 'giả sử', 'ký giả', 'do dự', 'ra-đi-ô', 'ra-đa',
            'gia vị', 'khá giả', 'thi đua', 'gò ghề', 'đi nhẹ', 'thứ tự', 'thư từ', 'tu bổ', 'bò dê', 'tỉ mỉ'
        ];

        // --- 2. Lấy các phần tử DOM ---
        const speakBtn = document.getElementById('speak-btn');
        const optionsContainer = document.getElementById('options-container');
        const feedbackEl = document.getElementById('feedback');
        const nextBtn = document.getElementById('next-btn');
        const progressEl = document.getElementById('progress');
        const scoreEl = document.getElementById('score');
        const quizArea = document.getElementById('quiz-area');
        const resultScreen = document.getElementById('result-screen');
        const finalScoreEl = document.getElementById('final-score');
        const restartBtn = document.getElementById('restart-btn');

        // --- 3. Trạng thái của ứng dụng ---
        let gameState = {
            shuffledWords: [],
            currentWordIndex: 0,
            score: 0,
            correctAnswer: '',
            voice: null,
        };

        // --- 4. Các hàm chức năng cốt lõi ---

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function speak(text) {
            if (!text || !gameState.voice) return;
            speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.voice = gameState.voice;
            utterance.lang = gameState.voice.lang;
            utterance.rate = 0.9;
            speechSynthesis.speak(utterance);
        }
        
        // CẬP NHẬT: Thuật toán tạo đáp án sai thông minh hơn
        function generateDistractors(word) {
            const distractors = new Set();
            const MAX_ATTEMPTS = 100;
            let attempts = 0;

            const originalParts = word.split(' ');

            const toneMap = { 'a': ['á', 'à', 'ả', 'ã', 'ạ'], 'ă': ['ắ', 'ằ', 'ẳ', 'ẵ', 'ặ'], 'â': ['ấ', 'ầ', 'ẩ', 'ẫ', 'ậ'], 'e': ['é', 'è', 'ẻ', 'ẽ', 'ẹ'], 'ê': ['ế', 'ề', 'ể', 'ễ', 'ệ'], 'i': ['í', 'ì', 'ỉ', 'ĩ', 'ị'], 'o': ['ó', 'ò', 'ỏ', 'õ', 'ọ'], 'ô': ['ố', 'ồ', 'ổ', 'ỗ', 'ộ'], 'ơ': ['ớ', 'ờ', 'ở', 'ỡ', 'ợ'], 'u': ['ú', 'ù', 'ủ', 'ũ', 'ụ'], 'ư': ['ứ', 'ừ', 'ử', 'ữ', 'ự'], 'y': ['ý', 'ỳ', 'ỷ', 'ỹ', 'ỵ'] };
            const initialConsonants = { 's': 'x', 'x': 's', 'tr': 'ch', 'ch': 'tr', 'd': 'gi', 'gi': 'd', 'r': 'gi', 'l': 'n', 'n': 'l' };
            const finalConsonants = { 'n': 'ng', 'ng': 'n', 't': 'c', 'c': 't', 'm': 'n', 'p': 't' };
            const vowelGroups = { 'ươi': 'uoi', 'uoi': 'ươi', 'iêu': 'iu', 'iu': 'iêu', 'yêu': 'iêu', 'ua': 'oa', 'oa': 'ua' };

            while (distractors.size < 3 && attempts < MAX_ATTEMPTS) {
                let currentParts = [...originalParts];
                let newWord = word;
                const strategy = Math.random();

                const partIndex = Math.floor(Math.random() * currentParts.length);
                let partToChange = currentParts[partIndex];
                let changed = false;

                if (strategy < 0.4) { // Lỗi Dấu Thanh
                    let chars = Array.from(partToChange);
                    let vowelIndices = [];
                    chars.forEach((char, index) => {
                        const normalized = char.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                        if (toneMap[normalized]) vowelIndices.push(index);
                    });
                    if (vowelIndices.length > 0) {
                        const indexToChange = vowelIndices[Math.floor(Math.random() * vowelIndices.length)];
                        const originalChar = chars[indexToChange];
                        const baseChar = originalChar.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                        const possibleTones = toneMap[baseChar].filter(c => c !== originalChar);
                        if (possibleTones.length > 0) {
                            chars[indexToChange] = possibleTones[Math.floor(Math.random() * possibleTones.length)];
                            currentParts[partIndex] = chars.join('');
                            changed = true;
                        }
                    }
                } else if (strategy < 0.7) { // Lỗi Phụ Âm Đầu
                    for (const [key, value] of Object.entries(initialConsonants)) {
                        if (partToChange.startsWith(key)) {
                            currentParts[partIndex] = value + partToChange.substring(key.length);
                            changed = true;
                            break;
                        }
                    }
                } else { // Lỗi Vần hoặc Phụ Âm Cuối
                    for (const [key, value] of Object.entries(vowelGroups)) {
                        if (partToChange.includes(key)) {
                            currentParts[partIndex] = partToChange.replace(key, value);
                            changed = true;
                            break;
                        }
                    }
                    if (!changed) {
                        for (const [key, value] of Object.entries(finalConsonants)) {
                            if (partToChange.endsWith(key)) {
                                currentParts[partIndex] = partToChange.substring(0, partToChange.length - key.length) + value;
                                changed = true;
                                break;
                            }
                        }
                    }
                }

                if (changed) {
                    newWord = currentParts.join(' ');
                    if (newWord !== word) {
                        distractors.add(newWord);
                    }
                }
                attempts++;
            }
            
            // Nếu vẫn không đủ, dùng một phương pháp đơn giản hơn làm dự phòng
            while (distractors.size < 3 && attempts < MAX_ATTEMPTS * 2) {
                 let tempWord = word;
                 const oldReplacements = { 's': 'x', 'x': 's', 'tr': 'ch', 'ch': 'tr', 'd': 'gi', 'gi': 'd', 'r': 'd', 'l': 'n', 'n': 'l', 'i': 'y', 'y': 'i', 'au': 'âu', 'âu': 'au', 'ay': 'ây', 'ây': 'ay' };
                 const keys = shuffle(Object.keys(oldReplacements));
                 for (const key of keys) {
                     if (tempWord.includes(key)) {
                         tempWord = tempWord.replace(key, oldReplacements[key]);
                         break; // Chỉ thay đổi một lỗi mỗi lần
                     }
                 }
                 if (tempWord !== word) {
                     distractors.add(tempWord);
                 }
                 attempts++;
            }

            return Array.from(distractors);
        }

        function renderQuestion() {
            optionsContainer.innerHTML = '';
            feedbackEl.textContent = '';
            nextBtn.classList.add('hidden');
            
            gameState.correctAnswer = gameState.shuffledWords[gameState.currentWordIndex];
            
            const distractors = generateDistractors(gameState.correctAnswer);
            const options = shuffle([gameState.correctAnswer, ...distractors]);

            options.forEach(optionText => {
                const button = document.createElement('button');
                button.textContent = optionText;
                button.className = 'btn-option w-full p-4 rounded-lg text-xl';
                button.onclick = () => handleAnswer(optionText, button);
                optionsContainer.appendChild(button);
            });

            progressEl.textContent = `问题 ${gameState.currentWordIndex + 1} / ${words.length}`;
            scoreEl.textContent = `分数: ${gameState.score}`;
        }

        function handleAnswer(selectedOption, buttonEl) {
            const allButtons = optionsContainer.querySelectorAll('button');
            allButtons.forEach(btn => btn.disabled = true);

            if (selectedOption === gameState.correctAnswer) {
                gameState.score++;
                buttonEl.classList.add('btn-correct');
                feedbackEl.textContent = '正确！ 🎉';
                feedbackEl.style.color = '#6A994E';
            } else {
                buttonEl.classList.add('btn-wrong');
                feedbackEl.innerHTML = `错误！正确答案是：<br><strong class="text-amber-800">${gameState.correctAnswer}</strong>`;
                feedbackEl.style.color = '#B56576';
                allButtons.forEach(btn => {
                    if (btn.textContent === gameState.correctAnswer) {
                        btn.classList.add('btn-correct');
                    }
                });
            }
            
            scoreEl.textContent = `分数: ${gameState.score}`;
            nextBtn.classList.remove('hidden');
        }

        function nextQuestion() {
            gameState.currentWordIndex++;
            if (gameState.currentWordIndex < words.length) {
                renderQuestion();
                setTimeout(() => speak(gameState.correctAnswer), 100);
            } else {
                showResults();
            }
        }

        function showResults() {
            quizArea.classList.add('hidden');
            resultScreen.classList.remove('hidden');
            finalScoreEl.textContent = `你的最终分数是：${gameState.score} / ${words.length}`;
        }
        
        function startGame() {
            gameState.shuffledWords = shuffle([...words]);
            gameState.currentWordIndex = 0;
            gameState.score = 0;

            quizArea.classList.remove('hidden');
            resultScreen.classList.add('hidden');
            
            renderQuestion();
        }

        // --- 5. Logic Khởi tạo ---

        function initializeSpeechSynthesis() {
            let voices = speechSynthesis.getVoices();

            if (voices.length === 0) {
                setTimeout(initializeSpeechSynthesis, 50);
                return;
            }
            
            const desiredLangs = ['vi-VN', 'vi_VN'];
            let foundVoice = voices.find(v => desiredLangs.includes(v.lang)) || voices.find(v => v.lang.startsWith('vi')) || voices[0];
            
            if (foundVoice) {
                gameState.voice = foundVoice;
                speakBtn.disabled = false;
                console.log("Voice ready:", gameState.voice.name);
                speak(gameState.correctAnswer);
            }
        }

        // --- 6. Gắn các sự kiện ---
        speakBtn.addEventListener('click', () => speak(gameState.correctAnswer));
        nextBtn.addEventListener('click', nextQuestion);
        restartBtn.addEventListener('click', startGame);

        // --- 7. Bắt đầu ứng dụng ---
        document.addEventListener('DOMContentLoaded', () => {
            startGame(); 
            initializeSpeechSynthesis(); 
        });

    </script>
</body>
</html>
